<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Exports Visualization</title>

  <!-- Load PyScript CSS and JS with versioned URLs and CORS enabled -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2022.12.1/pyscript.css" crossorigin="anonymous" />
  <script defer src="https://pyscript.net/releases/2022.12.1/pyscript.js" crossorigin="anonymous"></script>

  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    select {
      margin-bottom: 1rem;
      padding: 0.2rem;
    }
    #table {
      margin-top: 1rem;
    }
    #map {
      margin-top: 1rem;
    }
  </style>
</head>
<body>

<h2>Exports Dashboard</h2>

<!-- Place the dropdown and container elements before the PyScript block so that they are present when called -->
<select id="state-dropdown" onchange="updateView()"></select>
<div id="table"></div>
<div id="map"></div>

<!-- Define JavaScript functions that Python can call -->
<script>
  // This function populates the dropdown using the state list provided from Python.
  function populateDropdown(states) {
    // Convert the PyProxy (Python list) to a JavaScript array.
    const stateArray = states.toJs();
    const dropdown = document.getElementById("state-dropdown");
    // Clear any existing options.
    dropdown.innerHTML = "";
    // Populate the dropdown.
    stateArray.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      dropdown.appendChild(opt);
    });
    // Once populated, call updateView to display the first state's data.
    updateView();
  }

  // This function calls the Python function to update the table and map.
  async function updateView() {
    const state = document.getElementById("state-dropdown").value;
    // Get the Python function from the Pyodide globals.
    const pyFunc = window.pyodide.globals.get("get_top_20_by_state");
    // Call the Python function and convert the returned tuple to a JS array.
    let [tableHtml, mapHtml] = await pyFunc(state).toJs();
    document.getElementById("table").innerHTML = tableHtml;
    document.getElementById("map").innerHTML = mapHtml;
  }
</script>

<!-- The PyScript block: load the CSV and then call populateDropdown in JS -->
<py-script>
import pandas as pd
import plotly.express as px
import plotly.io as pio
from pyodide.http import pyfetch
import io
import asyncio

# Global variables for use within Python.
df = None
state_list = None

async def load_csv():
    response = await pyfetch("state_exp_by_ports_and_countries.csv")
    csv_text = await response.string()
    return pd.read_csv(io.StringIO(csv_text))

def get_top_20_by_state(state):
    # Filter the dataframe on the chosen state.
    subset = df[df["State"] == state]
    grouped = subset.groupby("Country", as_index=False).agg({"AM24_INR": "sum", "AM24_USD": "sum"})
    top_20 = grouped.sort_values("AM24_USD", ascending=False).head(20)
    table_html = top_20.to_html(index=False)
    fig = px.scatter_geo(
        top_20,
        locations="Country",
        locationmode="country names",
        hover_name="Country",
        size="AM24_USD",
        color="AM24_USD",
        projection="natural earth",
        title=f"Top 20 Destinations from {state}"
    )
    map_html = pio.to_html(fig, full_html=False, include_plotlyjs="cdn")
    return table_html, map_html

async def main():
    global df, state_list
    try:
        df = await load_csv()
        # Clean up column names to remove any extra whitespace.
        df.columns = df.columns.str.strip()
        print("CSV loaded successfully. DataFrame head:")
        print(df.head())
        state_list = sorted(df["State"].unique())
        print("State list:", state_list)
        # Import and call the JS function to populate the dropdown.
        from js import populateDropdown
        populateDropdown(state_list)
    except Exception as e:
        print("Error in main:", e)

# Schedule the main coroutine.
asyncio.ensure_future(main())
</py-script>

</body>
</html>
